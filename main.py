import os
import re
import vertexai
import uuid
from flask import Flask, request, jsonify, render_template
from vertexai.language_models import ChatModel, InputOutputTextPair,TextGenerationModel
#Firestore Admin and Connection
import firebase_admin
from firebase_admin import firestore

from datetime import datetime
import pytz

app = Flask(__name__)

PROJECT_ID = os.getenv("PROJECT_ID")
LOCATION = os.getenv("LOCATION") 

# Application Default credentials are automatically created.
firebase_app = firebase_admin.initialize_app()
db = firestore.client()

vertexai.init(project=PROJECT_ID, location=LOCATION)
chat_model = vertexai.language_models.ChatModel.from_pretrained("chat-bison@001")
chat = None

def response(chat, message, x_session_id):
    parameters = {
        "temperature": 1,
        "max_output_tokens": 512,
        "top_p": 0.9,
        "top_k": 40
    }
    result = chat.send_message(message, **parameters)
    #try and catch store firestore message and with timestamp
    #get timestamp to store
    timestamp = datetime.now(pytz.utc)
    try:
        doc_ref = db.collection('chat_logs_v2').document()
        doc_ref.set({
            u'input': message,
            u'output': result.text,
            u'timestamp': timestamp,
            u'x_session_id': x_session_id
        })
    except Exception as e:
        print("Error: {0}".format(e))
        print("Error saving message in firestore")
    #generateHTMLButtons(result)
    return result.text

def generateHTMLButtons(BotMessage):
    vertexai.init(project=PROJECT_ID, location=LOCATION)
    print(f"BotMessage: {BotMessage}")
    parameters = {
        "candidate_count": 1,
        "max_output_tokens": 1024,
        "temperature": 0.9,
        "top_p": 1
    }
    model = TextGenerationModel.from_pretrained("text-bison")
    response = model.predict(
        """For the last questions always convert them into html <button> OPTION </button>

    input: We are going into the forest, now appears a tiger...what should we do? run or fight? 
    output: <button>Run</button> <button>Fight</button>

    input: Â¡Genial! Entonces, imaginemos que te encuentras en un bosque nevado, y que el elfo estÃ¡ contigo. De repente, oyes un ruido... Â¿quÃ© quieres hacer? <button>Buscar de dÃ³nde viene</button> <button>No hacer nada</button>
    output: <button>Buscar de dÃ³nde viene</button> <button>No hacer nada</button>

    input: Â¡Muy bien! Entonces, vas a buscar de dÃ³nde viene el ruido, y encuentras una casa en el bosque. Â¿Quieres entrar en la casa? 
    output: <button>SÃ­</button> <button>No</button>

    input: Hola! Â¿Quieres crear una historia navideÃ±a conmigo?
    output: <button>SÃ­</button> <button>No</button>
    
    input:{BotMessage}
    output:
    """,
        **parameters
    )
    print(f"Response from Model: {response.text}")
    return response.text
#
#     examples=[
#      InputOutputTextPair(
#            input_text="Create an history where you ask me about the next step to go",
#            output_text="Step 1: We are going into the forest, now appears a zombie ðŸ§Ÿ that smells your fear...what should we do? run or fight? <button>Run</button> <button>Fight</button>",
#        ),
#        InputOutputTextPair(
#            input_text="Fight",
#            output_text="Step 2: The zombie ðŸ§Ÿ is attacking us, but you find a stick and you are going to make him giggles and you won...now you are walking to find your friend and you need to take some water, oh no the water is weird, maybe you will need to decide to drink it or not? What you should do ?<button>Drink it</button> <button>Not drink it</button>",
#        ),
#         InputOutputTextPair(
#            input_text="Drink it",
#            output_text="Step 3: It is a magic water!! now you are a wizard!, but your friend is becoming a zombie, Do you use your magic to save your friend? What you should do ? <button>Save him</button> <button>Not save him</button>",
#        )
#    ],
#


@app.route('/initiate-session', methods=['POST'])
def run_chat():
    #generate uuid 
    uuid_str = str(uuid.uuid4())
    global chat
    chat = chat_model.start_chat(
    context="You are a storyteller with the topic of zombies, really creative assigning steps and asking on the next steps to the user. Only answer according to the zombies story otherwise say sorry and continue creating the story. Ask if I want to have some companion. Always ends with a question to the user to decide which path to go. Answer verbosely and ask the language to begin. Ends always with a question to the user",
    examples=[
        InputOutputTextPair(
            input_text="Create an history where you ask me about the next step to go",
            output_text="You wake up to a chaotic world where a mysterious virus has turned many people into zombies. The streets are filled with panic and the undead. Your immediate goal is to find a safe place. What do you decide? <button>Stay in your current location and fortify it.</button> <button>Head out to find a more secure location, like a mall or a police station.</button><button>Go to a nearby rural area where there might be fewer zombies.</button>",
        ),
        InputOutputTextPair(
            input_text="Stay in the current location",
            output_text="You realize that you need supplies to survive. This includes food, water, medical supplies, and weapons. What do you do ? <button>Search nearby houses cautiously.</button> <button>Go to a nearby supermarket, which might have more supplies but is riskier.</button>",
        ),
         InputOutputTextPair(
            input_text="Search nearby",
            output_text="While scavenging, you encounter a group of survivors. They seem friendly but desperate. What you should do ? <button>Join forces with them and share resources.</button> <button>Stay alone, as trusting others can be risky</button>",
        )
    ],
    )
    #chat = chat_model.start_chat()
    print(f"Chat Session created")
    #print(f"Chat Session: {chat}")
    return {"session_id": uuid_str}

def get_documents_by_session_id(session_id):
    #docs = db.collection('chat_logs_v2').where('x_session_id', '==', session_id).stream()
    docs = db.collection('chat_logs_v2').where('x_session_id', '==', session_id).order_by('timestamp').stream()

    return [doc.to_dict() for doc in docs]

def compile_and_display_outputs(session_id):
    documents = get_documents_by_session_id(session_id)
    print(f"Documents: {documents}")
    print("----")
    for item in documents:
        # Check if output has button tags using regular expression
        if re.search(r"<button>", item["output"]):
            # Apply the filter
            item["output"] = re.sub(r"<button>(.*?)</button>", r"- \1 or ", item["output"])
            # Remove extra "or" at the end
            item["output"] = item["output"][:-4]
        else:
         # Leave the text unmodified if no buttons exist
            pass
    outputs = [doc['output'] for doc in documents if 'output' in doc]

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
    for output in outputs:
        print(output)
        
    return outputs

def remove_buttons_and_modify(doc):
    if 'output' in doc:
        new_output = re.sub(r"<button>.*?</button>", "-", doc['output'], flags=re.DOTALL)
        # Add other modifications as needed, e.g., new_output = new_output.upper()
        return new_output
    else:
        return None  # Handle documents without 'output'
    
@app.route('/show-all-story', methods=['GET'])
def get_generated_story():
    db = firestore.client()
    x_session_id = request.headers.get('X-Session-Id')
    print(f"X-Session-Id: {x_session_id}")
    # Get all documents where x_session_id exists
    #docs = db.collection("chat_logs_v2").where("x_session_id", "==", x_session_id).stream()
   # Example usage
    all_outputs= compile_and_display_outputs(x_session_id)


    return jsonify({'story': all_outputs}), 200
    #return render_template('my-story.html', story=all_outputs)

@app.route('/send_message', methods=['POST'])
def send_message():
    message = request.json.get('message', '')
    print(f"Message received: {message}")
    x_session_id = request.headers.get('X-Session-Id')
    #print(f"X-Session-Id: {x_session_id}")
    #print(f"Chat Session: {chat}")
    
    if not message:
        return jsonify({'error': 'Missing message'}), 400
    else:
        content = response(chat, message, x_session_id)
        return jsonify({'message': content}), 200
    
@app.route('/')
def index():
    return render_template('index.html')

if __name__ == '__main__':
     app.run(debug=True, host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))